<!DOCTYPE html>
<html lang="en" class="bg-gray-950 text-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sharme Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .mono { font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace; }
    .tab-active { border-bottom: 2px solid #818cf8; color: #818cf8; }
    .tab-inactive { border-bottom: 2px solid transparent; color: #9ca3af; cursor: pointer; }
    .tab-inactive:hover { color: #c7d2fe; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .hex-block { word-break: break-all; line-height: 1.6; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8 max-w-4xl mx-auto">

  <header class="mb-10">
    <h1 class="text-3xl font-bold tracking-tight">Sharme <span class="text-indigo-400 font-normal text-lg ml-2">Demo</span></h1>
    <p class="text-gray-400 mt-1">Sovereign, portable LLM context &mdash; end-to-end walkthrough with real Arweave uploads.</p>
  </header>

  <!-- ─── Step 1: Init ──────────────────────────────────── -->
  <section id="step-init" class="mb-8">
    <div class="flex items-center gap-3 mb-4">
      <span id="badge-init" class="w-7 h-7 rounded-full bg-indigo-600 text-white text-sm font-bold flex items-center justify-center">1</span>
      <h2 class="text-xl font-semibold">Initialize</h2>
    </div>
    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
      <p class="text-gray-400 text-sm mb-4">Sharme generates a 12-word recovery phrase. This phrase deterministically derives your identity (secp256k1 keypair) and encryption key (AES-256 via Argon2id). Write it down &mdash; it's the only way to recover your memory on a new device.</p>

      <!-- Step 1a: Generate phrase -->
      <div id="phase-generate">
        <button id="btn-generate" onclick="doGenerate()"
          class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded text-sm font-medium transition-colors">
          Generate Recovery Phrase
        </button>
      </div>

      <!-- Step 1b: Show phrase + confirm -->
      <div id="phase-confirm" class="hidden fade-in">
        <div class="bg-gray-800 border border-indigo-500/30 rounded-lg p-5 mb-4">
          <div class="text-gray-500 text-xs mb-3 uppercase tracking-wide">Your Recovery Phrase — write this down</div>
          <div id="phrase-display" class="flex flex-wrap gap-3 mb-1"></div>
        </div>
        <div class="flex gap-3 items-end">
          <div class="flex-1">
            <label id="confirm-label" class="block text-sm text-gray-500 mb-1">Confirm word ? and ?</label>
            <div class="flex gap-2">
              <input id="confirm-word1" type="text" placeholder="word ?"
                class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mono focus:outline-none focus:border-indigo-500" />
              <input id="confirm-word2" type="text" placeholder="word ?"
                class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mono focus:outline-none focus:border-indigo-500" />
            </div>
          </div>
          <button id="btn-init" onclick="doInit()"
            class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2 rounded text-sm font-medium transition-colors">
            Confirm &amp; Initialize
          </button>
        </div>
      </div>

      <div id="init-result" class="hidden mt-4 fade-in"></div>
    </div>
  </section>

  <!-- ─── Step 2: Store Facts ───────────────────────────── -->
  <section id="step-store" class="mb-8 opacity-40 pointer-events-none">
    <div class="flex items-center gap-3 mb-4">
      <span id="badge-store" class="w-7 h-7 rounded-full bg-gray-700 text-gray-400 text-sm font-bold flex items-center justify-center">2</span>
      <h2 class="text-xl font-semibold">Store Facts</h2>
    </div>
    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
      <p class="text-gray-400 text-sm mb-4">Store structured facts into the local SQLite database. Status: <span class="text-yellow-400 mono text-xs">dirty</span> &rarr; <span class="text-blue-400 mono text-xs">sharded</span> &rarr; <span class="text-green-400 mono text-xs">synced</span> (on Arweave).</p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
        <div>
          <label class="block text-sm text-gray-500 mb-1">Key</label>
          <input id="fact-key" type="text" placeholder="preference:language"
            class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mono focus:outline-none focus:border-indigo-500" />
        </div>
        <div>
          <label class="block text-sm text-gray-500 mb-1">Value</label>
          <input id="fact-value" type="text" placeholder="TypeScript, always"
            class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mono focus:outline-none focus:border-indigo-500" />
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
        <div>
          <label class="block text-sm text-gray-500 mb-1">Scope</label>
          <select id="fact-scope"
            class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mono focus:outline-none focus:border-indigo-500">
            <option value="global">global</option>
            <option value="project:demo">project:demo</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-500 mb-1">Tags (comma-separated)</label>
          <input id="fact-tags" type="text" placeholder="preference, language"
            class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mono focus:outline-none focus:border-indigo-500" />
        </div>
      </div>
      <div class="flex gap-3">
        <button onclick="doStore()"
          class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded text-sm font-medium transition-colors">
          Store Fact
        </button>
        <button onclick="doStoreExamples()"
          class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-5 py-2 rounded text-sm font-medium transition-colors">
          Add 3 Examples
        </button>
      </div>

      <div id="facts-table" class="mt-5"></div>
    </div>
  </section>

  <!-- ─── Step 3: Create Shard ──────────────────────────── -->
  <section id="step-shard" class="mb-8 opacity-40 pointer-events-none">
    <div class="flex items-center gap-3 mb-4">
      <span id="badge-shard" class="w-7 h-7 rounded-full bg-gray-700 text-gray-400 text-sm font-bold flex items-center justify-center">3</span>
      <h2 class="text-xl font-semibold">Create Delta Shard</h2>
    </div>
    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
      <p class="text-gray-400 text-sm mb-4">Collect all dirty facts into a delta shard, serialize to JSON, then encrypt with AES-256-GCM. Each shard stays under 90 KiB (Turbo free tier).</p>
      <button id="btn-shard" onclick="doShard()"
        class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded text-sm font-medium transition-colors">
        Create Delta Shard
      </button>
      <div id="shard-result" class="hidden mt-5 fade-in"></div>
    </div>
  </section>

  <!-- ─── Step 4: Push to Arweave ───────────────────────── -->
  <section id="step-push" class="mb-8 opacity-40 pointer-events-none">
    <div class="flex items-center gap-3 mb-4">
      <span id="badge-push" class="w-7 h-7 rounded-full bg-gray-700 text-gray-400 text-sm font-bold flex items-center justify-center">4</span>
      <h2 class="text-xl font-semibold">Push to Arweave</h2>
    </div>
    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
      <p class="text-gray-400 text-sm mb-4">Upload the encrypted shard(s) to Arweave via Turbo. Files under 100 KiB are free on mainnet. Data is permanent and immutable.</p>
      <button id="btn-push" onclick="doPush()"
        class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2 rounded text-sm font-medium transition-colors">
        Push to Arweave (mainnet)
      </button>
      <div id="push-result" class="hidden mt-5 fade-in"></div>
    </div>
  </section>

  <!-- ─── Step 5: Reconstruct ─────────────────────────────── -->
  <section id="step-reconstruct" class="mb-8 opacity-40 pointer-events-none">
    <div class="flex items-center gap-3 mb-4">
      <span id="badge-reconstruct" class="w-7 h-7 rounded-full bg-gray-700 text-gray-400 text-sm font-bold flex items-center justify-center">5</span>
      <h2 class="text-xl font-semibold">Wipe &amp; Reconstruct</h2>
    </div>
    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6">
      <p class="text-gray-400 text-sm mb-4">Simulate a new device: destroy all local data, then reconstruct from Arweave using only the transaction IDs and your recovery phrase. This proves your memory is sovereign and portable.</p>

      <div class="flex gap-3 mb-4">
        <button id="btn-wipe" onclick="doWipe()"
          class="bg-red-700 hover:bg-red-600 text-white px-5 py-2 rounded text-sm font-medium transition-colors">
          Wipe Local Data
        </button>
        <button id="btn-reconstruct" onclick="doReconstruct()" disabled
          class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2 rounded text-sm font-medium transition-colors opacity-40">
          Reconstruct from Arweave
        </button>
      </div>

      <div id="wipe-result" class="hidden fade-in"></div>
      <div id="reconstruct-result" class="hidden mt-4 fade-in"></div>
    </div>
  </section>

  <!-- ─── Reset ─────────────────────────────────────────── -->
  <div class="border-t border-gray-800 pt-6 mt-12 flex justify-between items-center">
    <p class="text-gray-600 text-sm">Demo data is ephemeral &mdash; stored in a temp directory.</p>
    <button onclick="doReset()"
      class="text-red-400 hover:text-red-300 text-sm underline">
      Reset Everything
    </button>
  </div>

<script>
const API = '';

// ── Helpers ─────────────────────────────────────────────

async function api(path, opts = {}) {
  const res = await fetch(API + path, {
    headers: { 'Content-Type': 'application/json' },
    ...opts,
  });
  const data = await res.json();
  if (!res.ok && data.error) throw new Error(data.error);
  return data;
}

function el(id) { return document.getElementById(id); }

function unlock(stepId) {
  const section = el(stepId);
  section.classList.remove('opacity-40', 'pointer-events-none');
  const badge = section.querySelector('[id^="badge-"]');
  if (badge) {
    badge.classList.remove('bg-gray-700', 'text-gray-400');
    badge.classList.add('bg-indigo-600', 'text-white');
  }
}

function setLoading(btnId, loading) {
  const btn = el(btnId);
  if (loading) {
    btn.disabled = true;
    btn.dataset.originalText = btn.textContent;
    btn.textContent = 'Working...';
    btn.classList.add('opacity-60');
  } else {
    btn.disabled = false;
    btn.textContent = btn.dataset.originalText;
    btn.classList.remove('opacity-60');
  }
}

function truncHex(hex, maxLen = 200) {
  if (hex.length <= maxLen) return hex;
  return hex.slice(0, maxLen / 2) + ' ... ' + hex.slice(-maxLen / 2);
}

// ── Step 1: Generate Phrase + Init ──────────────────────

let generatedPhrase = null;
let confirmIdx1 = 0;
let confirmIdx2 = 0;

async function doGenerate() {
  setLoading('btn-generate', true);
  try {
    const data = await api('/api/generate-phrase', { method: 'POST' });
    generatedPhrase = data.words;
    confirmIdx1 = data.confirmWord1;
    confirmIdx2 = data.confirmWord2;

    // Show numbered words
    const display = el('phrase-display');
    display.innerHTML = data.words.map((w, i) =>
      `<span class="bg-gray-700 border border-gray-600 rounded px-3 py-2 mono text-sm">
        <span class="text-gray-500 text-xs mr-1">${i + 1}.</span>
        <span class="text-indigo-300">${w}</span>
      </span>`
    ).join('');

    // Update confirmation labels
    el('confirm-label').textContent = `Confirm word ${confirmIdx1} and ${confirmIdx2}`;
    el('confirm-word1').placeholder = `word ${confirmIdx1}`;
    el('confirm-word2').placeholder = `word ${confirmIdx2}`;

    // Switch phases
    el('phase-generate').classList.add('hidden');
    el('phase-confirm').classList.remove('hidden');
  } catch (err) {
    alert('Generate failed: ' + err.message);
    setLoading('btn-generate', false);
  }
}

async function doInit() {
  const word1 = el('confirm-word1').value.trim();
  const word2 = el('confirm-word2').value.trim();
  if (!word1 || !word2) return alert('Type both confirmation words');

  setLoading('btn-init', true);
  try {
    const data = await api('/api/init', {
      method: 'POST',
      body: JSON.stringify({ word1, word2 }),
    });

    el('init-result').innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-800 rounded p-3">
          <div class="text-gray-500 text-xs mb-1">Wallet Address</div>
          <div class="mono text-sm text-indigo-300 break-all">${data.wallet}</div>
        </div>
        <div class="bg-gray-800 rounded p-3">
          <div class="text-gray-500 text-xs mb-1">Key Derivation (Argon2id)</div>
          <div class="mono text-sm">${data.derivationMs}ms &rarr; ${data.keyBits}-bit AES key</div>
        </div>
        <div class="bg-gray-800 rounded p-3">
          <div class="text-gray-500 text-xs mb-1">Salt</div>
          <div class="mono text-xs text-gray-400 break-all">${data.saltHex}</div>
        </div>
        <div class="bg-gray-800 rounded p-3">
          <div class="text-gray-500 text-xs mb-1">Recovery Phrase</div>
          <div class="mono text-xs text-emerald-400">${generatedPhrase.join(' ')}</div>
        </div>
      </div>
    `;
    el('init-result').classList.remove('hidden');

    // Disable init UI
    el('btn-init').disabled = true;
    el('btn-init').textContent = 'Initialized';
    el('btn-init').classList.add('opacity-40');
    el('confirm-word1').disabled = true;
    el('confirm-word2').disabled = true;

    unlock('step-store');
  } catch (err) {
    alert('Init failed: ' + err.message);
    setLoading('btn-init', false);
  }
}

// ── Step 2: Store Facts ─────────────────────────────────

async function doStore() {
  const key = el('fact-key').value.trim();
  const value = el('fact-value').value.trim();
  const scope = el('fact-scope').value;
  const tagsRaw = el('fact-tags').value.trim();
  const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];

  if (!key || !value) return alert('Key and value are required');

  await api('/api/store', {
    method: 'POST',
    body: JSON.stringify({ key, value, scope, tags }),
  });

  el('fact-key').value = '';
  el('fact-value').value = '';
  el('fact-tags').value = '';

  await refreshFacts();
}

async function doStoreExamples() {
  const examples = [
    { key: 'preference:language', value: 'TypeScript, always', scope: 'global', tags: ['preference', 'language'] },
    { key: 'preference:style', value: 'Functional over OOP, minimal abstractions', scope: 'global', tags: ['preference', 'code-style'] },
    { key: 'architecture:storage', value: 'Arweave for permanent decentralized storage, SQLite for local cache', scope: 'project:demo', tags: ['architecture', 'storage', 'decision'] },
  ];

  for (const ex of examples) {
    await api('/api/store', { method: 'POST', body: JSON.stringify(ex) });
  }

  await refreshFacts();
}

async function refreshFacts() {
  const data = await api('/api/facts');
  const facts = data.facts;

  if (facts.length === 0) {
    el('facts-table').innerHTML = '<p class="text-gray-600 text-sm">No facts stored yet.</p>';
    return;
  }

  const hasDirty = facts.some(f => f.status === 'dirty');
  if (hasDirty) {
    unlock('step-shard');
  }

  let html = `
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="text-left text-gray-500 text-xs border-b border-gray-800">
            <th class="pb-2 pr-3">Scope</th>
            <th class="pb-2 pr-3">Key</th>
            <th class="pb-2 pr-3">Value</th>
            <th class="pb-2 pr-3">Tags</th>
            <th class="pb-2">Status</th>
          </tr>
        </thead>
        <tbody>
  `;

  for (const f of facts) {
    const badges = {
      dirty:   '<span class="bg-yellow-900 text-yellow-300 text-xs px-2 py-0.5 rounded mono">dirty</span>',
      sharded: '<span class="bg-blue-900 text-blue-300 text-xs px-2 py-0.5 rounded mono">sharded</span>',
      synced:  '<span class="bg-green-900 text-green-300 text-xs px-2 py-0.5 rounded mono">synced</span>',
    };
    html += `
      <tr class="border-b border-gray-800/50">
        <td class="py-2 pr-3 mono text-xs text-gray-400">${f.scope}</td>
        <td class="py-2 pr-3 mono text-xs text-indigo-300">${f.key}</td>
        <td class="py-2 pr-3 text-gray-300">${f.value}</td>
        <td class="py-2 pr-3 text-xs text-gray-500">${f.tags.join(', ')}</td>
        <td class="py-2">${badges[f.status] || badges.dirty}</td>
      </tr>
    `;
  }

  html += '</tbody></table></div>';
  el('facts-table').innerHTML = html;
}

// ── Step 3: Create Shard ────────────────────────────────

let shardData = null;

async function doShard() {
  setLoading('btn-shard', true);
  try {
    const data = await api('/api/shard', { method: 'POST' });
    shardData = data;

    let html = `
      <div class="mb-4 flex gap-2">
        <span class="bg-gray-800 text-gray-300 px-3 py-1 rounded text-xs mono">
          ${data.shardCount} shard${data.shardCount > 1 ? 's' : ''}
        </span>
        <span class="bg-gray-800 text-gray-300 px-3 py-1 rounded text-xs mono">
          ${data.totalBytes} bytes encrypted
        </span>
        <span class="${data.underFreeLimit ? 'bg-emerald-900 text-emerald-300' : 'bg-red-900 text-red-300'} px-3 py-1 rounded text-xs mono">
          ${data.underFreeLimit ? 'Under 90 KiB — FREE' : 'Over 90 KiB limit'}
        </span>
      </div>
    `;

    for (const shard of data.shards) {
      html += `
        <div class="mb-4 bg-gray-800 rounded-lg overflow-hidden">
          <div class="flex border-b border-gray-700">
            <button class="shard-tab px-4 py-2 text-xs tab-active" onclick="showTab(this, 'json-${shard.version}')">
              Raw JSON
            </button>
            <button class="shard-tab px-4 py-2 text-xs tab-inactive" onclick="showTab(this, 'enc-${shard.version}')">
              Encrypted
            </button>
            <button class="shard-tab px-4 py-2 text-xs tab-inactive" onclick="showTab(this, 'stats-${shard.version}')">
              Stats
            </button>
            <span class="ml-auto px-4 py-2 text-xs text-gray-500 mono">v${shard.version}</span>
          </div>
          <div id="json-${shard.version}" class="p-4">
            <pre class="mono text-xs text-green-300 max-h-64 overflow-auto">${escapeHtml(shard.shardJson)}</pre>
          </div>
          <div id="enc-${shard.version}" class="p-4 hidden">
            <p class="text-gray-500 text-xs mb-2">AES-256-GCM output (12-byte nonce + ciphertext + 16-byte auth tag):</p>
            <div class="mono text-xs text-orange-300 hex-block max-h-48 overflow-auto">${truncHex(shard.encryptedHex, 600)}</div>
            <p class="text-gray-600 text-xs mt-2">${shard.encryptedHex.length / 2} bytes total</p>
          </div>
          <div id="stats-${shard.version}" class="p-4 hidden">
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <div class="text-gray-500 text-xs">Version</div>
                <div class="mono">${shard.version}</div>
              </div>
              <div>
                <div class="text-gray-500 text-xs">Filename</div>
                <div class="mono text-xs">${shard.filename}</div>
              </div>
              <div>
                <div class="text-gray-500 text-xs">Encrypted Size</div>
                <div class="mono">${shard.sizeBytes} bytes</div>
              </div>
              <div>
                <div class="text-gray-500 text-xs">Free Tier Limit</div>
                <div class="mono">${shard.sizeBytes < 92160 ? '< 90 KiB' : 'OVER LIMIT'}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    el('shard-result').innerHTML = html;
    el('shard-result').classList.remove('hidden');

    unlock('step-push');
    await refreshFacts();
  } catch (err) {
    alert('Shard failed: ' + err.message);
  }
  setLoading('btn-shard', false);
}

function showTab(clickedTab, panelId) {
  const container = clickedTab.closest('.bg-gray-800');
  container.querySelectorAll('.shard-tab').forEach(t => {
    t.classList.remove('tab-active');
    t.classList.add('tab-inactive');
  });
  clickedTab.classList.remove('tab-inactive');
  clickedTab.classList.add('tab-active');

  container.querySelectorAll('[id^="json-"], [id^="enc-"], [id^="stats-"]').forEach(p => {
    p.classList.add('hidden');
  });
  el(panelId).classList.remove('hidden');
}

function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// ── Step 4: Push to Arweave ─────────────────────────────

async function doPush() {
  setLoading('btn-push', true);
  try {
    const data = await api('/api/push', { method: 'POST' });

    let html = `
      <div class="bg-gray-800 rounded p-3 mb-4">
        <div class="text-gray-500 text-xs mb-1">Wallet (signer)</div>
        <div class="mono text-sm text-indigo-300 break-all">${data.wallet}</div>
      </div>
    `;

    for (const tx of data.transactions) {
      const typeLabel = tx.version === -1 ? 'Identity' : `Delta Shard v${tx.version}`;
      html += `
        <div class="bg-gray-800 rounded-lg p-4 mb-3 fade-in">
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium">${typeLabel}</span>
            <span class="mono text-xs text-gray-500">${tx.sizeBytes} bytes</span>
          </div>
          <div class="mb-3">
            <div class="text-gray-500 text-xs mb-1">Transaction ID</div>
            <a href="${tx.arweaveUrl}" target="_blank" rel="noopener"
              class="mono text-sm text-emerald-400 hover:text-emerald-300 break-all underline">
              ${tx.txId}
            </a>
          </div>
          <div>
            <div class="text-gray-500 text-xs mb-2">Arweave Tags</div>
            <div class="flex flex-wrap gap-2">
              ${tx.tags.map(t => `<span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded mono">${t.name}: ${t.value.length > 30 ? t.value.slice(0, 30) + '...' : t.value}</span>`).join('')}
            </div>
          </div>
        </div>
      `;
    }

    html += `
      <div class="mt-4 p-3 bg-emerald-900/30 border border-emerald-800 rounded text-sm text-emerald-300">
        Data is now permanently stored on Arweave. It can be reconstructed on any device using only your wallet address and passphrase.
      </div>
    `;

    el('push-result').innerHTML = html;
    el('push-result').classList.remove('hidden');

    el('btn-push').disabled = true;
    el('btn-push').textContent = 'Pushed';
    el('btn-push').classList.add('opacity-40');

    await refreshFacts();
    unlock('step-reconstruct');
  } catch (err) {
    alert('Push failed: ' + err.message);
  }
  setLoading('btn-push', false);
}

// ── Step 5: Wipe & Reconstruct ──────────────────────────

async function doWipe() {
  setLoading('btn-wipe', true);
  try {
    const data = await api('/api/wipe', { method: 'POST' });

    el('wipe-result').innerHTML = `
      <div class="bg-red-900/30 border border-red-800 rounded p-4 mb-4">
        <div class="text-red-300 text-sm font-medium mb-2">Local state destroyed</div>
        <p class="text-red-300/70 text-sm">SQLite database, shard files, encryption keys &mdash; all gone.</p>
        <p class="text-red-300/70 text-sm mt-1">Remaining: wallet address <span class="mono text-red-300">${data.wallet}</span> + ${data.txCount} Arweave TX(s) + your passphrase.</p>
      </div>
    `;
    el('wipe-result').classList.remove('hidden');

    // Update the facts table to show empty state
    el('facts-table').innerHTML = '<p class="text-red-400/60 text-sm mono">[ database wiped — 0 facts ]</p>';

    // Enable reconstruct button
    el('btn-reconstruct').disabled = false;
    el('btn-reconstruct').classList.remove('opacity-40');

    el('btn-wipe').disabled = true;
    el('btn-wipe').classList.add('opacity-40');
    el('btn-wipe').textContent = 'Wiped';
  } catch (err) {
    alert('Wipe failed: ' + err.message);
    setLoading('btn-wipe', false);
  }
}

async function doReconstruct() {
  setLoading('btn-reconstruct', true);
  try {
    const data = await api('/api/reconstruct', { method: 'POST' });

    let html = '<div class="space-y-2 mb-6">';
    html += '<div class="text-gray-400 text-xs font-medium mb-2">Reconstruction log:</div>';

    for (const s of data.steps) {
      let icon = '';
      let color = 'text-gray-400';

      if (s.step.includes('download')) { icon = '&darr;'; color = 'text-blue-400'; }
      else if (s.step.includes('decrypt') || s.step.includes('key_derived')) { icon = '&oplus;'; color = 'text-orange-400'; }
      else if (s.step.includes('replay') || s.step.includes('restored')) { icon = '&check;'; color = 'text-emerald-400'; }
      else if (s.step.includes('salt')) { icon = '&equiv;'; color = 'text-purple-400'; }
      else { icon = '&bull;'; }

      html += `<div class="flex items-start gap-2 text-sm"><span class="${color} mono">${icon}</span><span class="text-gray-300">${s.detail}</span></div>`;
    }
    html += '</div>';

    // Show reconstructed shards
    if (data.shards && data.shards.length > 0) {
      html += '<div class="mb-4">';
      html += '<div class="text-gray-400 text-xs font-medium mb-2">Decrypted shards from Arweave:</div>';
      for (const shard of data.shards) {
        html += `
          <details class="bg-gray-800 rounded mb-2">
            <summary class="px-4 py-2 text-sm cursor-pointer text-indigo-300 mono">Shard v${shard.version}</summary>
            <pre class="px-4 py-3 mono text-xs text-green-300 max-h-48 overflow-auto border-t border-gray-700">${escapeHtml(shard.shardJson)}</pre>
          </details>
        `;
      }
      html += '</div>';
    }

    // Show reconstructed facts
    if (data.facts && data.facts.length > 0) {
      html += `
        <div class="bg-emerald-900/30 border border-emerald-800 rounded p-4">
          <div class="text-emerald-300 text-sm font-medium mb-3">${data.factCount} fact(s) reconstructed from Arweave</div>
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 text-xs border-b border-emerald-800/50">
                <th class="pb-2 pr-3">Scope</th>
                <th class="pb-2 pr-3">Key</th>
                <th class="pb-2 pr-3">Value</th>
              </tr>
            </thead>
            <tbody>
      `;
      for (const f of data.facts) {
        html += `
          <tr class="border-b border-emerald-800/30">
            <td class="py-2 pr-3 mono text-xs text-gray-400">${f.scope}</td>
            <td class="py-2 pr-3 mono text-xs text-emerald-300">${f.key}</td>
            <td class="py-2 pr-3 text-gray-300">${f.value}</td>
          </tr>
        `;
      }
      html += '</tbody></table></div>';
    }

    el('reconstruct-result').innerHTML = html;
    el('reconstruct-result').classList.remove('hidden');

    el('btn-reconstruct').disabled = true;
    el('btn-reconstruct').textContent = 'Reconstructed';
    el('btn-reconstruct').classList.add('opacity-40');

    // Refresh the main facts table
    await refreshFacts();
  } catch (err) {
    alert('Reconstruct failed: ' + err.message);
  }
  setLoading('btn-reconstruct', false);
}

// ── Reset ───────────────────────────────────────────────

async function doReset() {
  if (!confirm('Wipe all demo data and start over?')) return;
  await api('/api/reset', { method: 'POST' });
  location.reload();
}

// ── Init on load ────────────────────────────────────────

(async function checkStatus() {
  try {
    const data = await api('/api/status');
    if (data.initialized) {
      // Restore state for already-initialized demo
      el('phase-generate').classList.add('hidden');
      el('phase-confirm').classList.add('hidden');

      el('init-result').innerHTML = `
        <div class="bg-gray-800 rounded p-3">
          <div class="text-gray-500 text-xs mb-1">Wallet (restored from session)</div>
          <div class="mono text-sm text-indigo-300 break-all">${data.wallet}</div>
        </div>
      `;
      el('init-result').classList.remove('hidden');

      unlock('step-store');
      await refreshFacts();
    }
  } catch (e) {
    // Server not ready yet
  }
})();
</script>

</body>
</html>
